<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Analisa 4D - Mahasewa</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #eee; padding: 20px; text-align: center; }
        .menu-tombol { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 5px; background: #333; color: white; font-weight: bold; transition: 0.3s; }
        button:hover { background: #555; }
        button.active { background: #d9534f; box-shadow: 0 0 10px rgba(217, 83, 79, 0.5); }
        .btn-generate { background: #f0ad4e; color: #000; margin-top: 10px; }
        .btn-generate:disabled { background: #555; color: #888; cursor: not-allowed; }

        .main-layout { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-bottom: 30px; }
        .card { background: #222; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); width: 100%; max-width: 450px; }
        
        .grid-2d { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; max-height: 300px; overflow-y: auto; padding: 10px; background: #111; border-radius: 5px; }
        .item-2d { background: #333; padding: 5px; border-radius: 3px; font-size: 1.1em; font-weight: bold; }
        .item-belum { color: #5cb85c; }

        /* Accordion Style */
        .accordion { background: #333; color: #fff; cursor: pointer; padding: 15px; width: 100%; border: none; text-align: left; outline: none; font-size: 1.1em; margin-top: 10px; border-radius: 5px; display: flex; justify-content: space-between; font-weight: bold; }
        .active-acc, .accordion:hover { background: #444; }
        .panel { padding: 0 18px; display: none; background-color: #1a1a1a; overflow: hidden; border: 1px solid #333; border-radius: 0 0 5px 5px; margin-bottom: 10px; }
        
        pre { background: #000; color: #0f0; padding: 15px; border-radius: 5px; text-align: left; font-family: 'Courier New', Courier, monospace; overflow-x: auto; border: 1px solid #444; }
        .badge { background: #d9534f; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
    </style>
</head>
<body>

    <h1>MESIN BBFS 4D MAHASEWA</h1>

    <div class="menu-tombol">
        <button onclick="pilihPasaran('hk', this)">HONGKONG</button>
        <button onclick="pilihPasaran('sdy', this)">SYDNEY</button>
        <button onclick="pilihPasaran('sgp', this)">SINGAPORE</button>
    </div>

    <div class="main-layout">
        <div class="card">
            <h2 id="judul-sudah">Data Keluar</h2>
            <div id="display-sudah" class="grid-2d">Pilih pasaran dulu</div>
        </div>
        <div class="card">
            <h2 id="judul-belum" style="color:#5cb85c">2D Hijau (Bahan)</h2>
            <div id="display-belum" class="grid-2d">Pilih pasaran dulu</div>
            <button id="btn4d" class="btn-generate" onclick="generate4D()" disabled>Pasangkan Menjadi 4D</button>
        </div>
    </div>

    <div id="hasil-container" style="max-width: 920px; margin: 0 auto; text-align: left;">
        <button class="accordion">HASIL 4D ACAK <span id="count-acak" class="badge">0 Line</span></button>
        <div class="panel" id="panel-acak"></div>

        <button class="accordion">HASIL 4D TWIN <span id="count-twin" class="badge">0 Line</span></button>
        <div class="panel" id="panel-twin"></div>
    </div>

    <script>
        const username = "Mahasewa";
        const repo = "mesin-bbfs";
        let dataHijau = [];
        let dataHistory = [];
        let pasaranAktif = "";

        async function pilihPasaran(pasaran, btn) {
            const tombols = document.querySelectorAll('.menu-tombol button');
            tombols.forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            pasaranAktif = pasaran;

            const url = `https://raw.githubusercontent.com/${username}/${repo}/main/data_keluaran_${pasaran}.txt`;
            try {
                const response = await fetch(url);
                const data = await response.text();
                dataHistory = data.trim().split("\n").map(line => line.trim());
                
                const barisTerakhir = [...dataHistory].slice(-100).reverse();
                let sudahKeluarArr = barisTerakhir.map(a => a.slice(-2));
                
                // Reset data hijau
                dataHijau = [];
                let htmlSudah = "";
                barisTerakhir.forEach(a => htmlSudah += `<div class="item-2d">${a.slice(-2)}</div>`);
                
                let htmlBelum = "";
                for(let i=0; i<=99; i++){
                    let n = i.toString().padStart(2, '0');
                    if(!sudahKeluarArr.includes(n)) {
                        dataHijau.push(n);
                        htmlBelum += `<div class="item-2d item-belum">${n}</div>`;
                    }
                }

                document.getElementById('display-sudah').innerHTML = htmlSudah;
                document.getElementById('display-belum').innerHTML = htmlBelum;
                document.getElementById('btn4d').disabled = false;
                document.getElementById('judul-belum').innerText = `2D Hijau (${dataHijau.length})`;
            } catch (e) { alert("Gagal ambil data!"); }
        }

        function generate4D() {
            let acak = [];
            let twin = [];

            dataHijau.forEach(ekor => {
                let ekor1 = ekor[0];
                let ekor2 = ekor[1];

                for (let i = 0; i <= 99; i++) {
                    let depan = i.toString().padStart(2, '0');
                    let gabung = depan + ekor;
                    let d1 = depan[0];
                    let d2 = depan[1];

                    // 1. Filter Quad & Triple
                    let counts = {};
                    for(let char of gabung) counts[char] = (counts[char] || 0) + 1;
                    let maxCount = Math.max(...Object.values(counts));
                    if (maxCount >= 3) continue;

                    // 2. Filter Seri Depan-Belakang (Jika ekor 11, depan dilarang x1)
                    if (ekor1 === ekor2 && d2 === ekor1) continue;

                    // 3. Filter Riwayat (Dilarang ada di data_keluaran.txt)
                    if (dataHistory.includes(gabung)) continue;

                    // Pisahkan Acak dan Twin
                    let unik = new Set(gabung).size;
                    if (unik === 4) acak.push(gabung);
                    else twin.push(gabung);
                }
            });

            tampilkanHasil(acak, 'panel-acak', 'count-acak');
            tampilkanHasil(twin, 'panel-twin', 'count-twin');
            alert("Proses Selesai, Koh!");
        }

        function tampilkanHasil(array, panelId, countId) {
            const panel = document.getElementById(panelId);
            document.getElementById(countId).innerText = array.length + " Line";
            panel.innerHTML = "";
            
            for (let i = 0; i < array.length; i += 300) {
                let chunk = array.slice(i, i + 300).join(", ");
                panel.innerHTML += `<h4>Blok ${Math.floor(i/300)+1}</h4><pre>${chunk}</pre>`;
            }
        }

        // Script Accordion
        var acc = document.getElementsByClassName("accordion");
        for (var i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active-acc");
                var panel = this.nextElementSibling;
                panel.style.display = (panel.style.display === "block") ? "none" : "block";
            });
        }
    </script>
</body>
</html>
